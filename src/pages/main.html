<template page>
  <l-m src="../comps/file-item.html"></l-m>
  <l-m src="../comps/file-tab.html"></l-m>
  <l-m src="../comps/code-area.html"></l-m>
  <style>
    :host {
      display: flex;
    }

    .second-pannel {
      width: 300px;
      border-right: var(--border-color) solid 1px;
      overflow: auto;
    }

    .second-pannel h4 {
      margin: 12px 0 4px 12px;
      padding: 0;
      font-size: 12px;
    }

    .main-pannel {
      display: flex;
      flex-direction: column;
      position: relative;
      flex: 1;
      background-color: #1f1f1f;
    }

    .main-tabs {
      display: flex;
      width: 100%;
      flex-wrap: wrap;
      background-color: var(--main-pannel-color);
    }

    .code-area {
      flex: 1;
    }

    .not-resident {
      font-style: italic;
    }
  </style>

  <div class="second-pannel">
    <h4>资源管理器</h4>
    <x-fill :value="list" name="file-item"></x-fill>

    <template name="file-item">
      <ocode-file-item
        attr:name="$data.name"
        attr:folder="$data.folder ? $data.folder : null"
        attr:selected="$data.path === $host.selectedFilePath ? '' : null"
        on:click="$host.clickItem($data,$event)"
        on:dblclick="$host.dblclickItem($data,$event)"
      >
        <x-if :value="$data.list">
          <x-fill :value="$data.list" name="file-item"></x-fill>
        </x-if>
      </ocode-file-item>
    </template>
  </div>
  <div class="main-pannel">
    <div class="main-tabs">
      <x-fill :value="tabs">
        <ocode-file-tab
          attr:name="$data.name"
          attr:selected="$host.selectedFilePath === $data.path ? '' : null"
          :path="$data.path"
          on:click="$host.clickTab($data,$event)"
          class:not-resident="$data.notResident"
          class:has-change="$data.hasChange"
          on:click-close="$host.clickTabClose($index)"
        ></ocode-file-tab>
      </x-fill>
    </div>
    <div class="code-area">
      <x-if :value="tabs.length">
        <ocode-area
          :selected-path="selectedFilePath"
          on:change="changeValue"
          on:change-tab-status="changeTabStatus"
        ></ocode-area>
      </x-if>
      <x-else>
        <o-page src="./start-page.html"></o-page>
      </x-else>
    </div>
  </div>
  <script>
    import { getListData } from "../util.js";

    export default async ({ load }) => {
      const { get } = await load("@nos/core/fs/local/main.js");

      return {
        data: {
          selectedFilePath: "",
          list: [],
          tabs: [],
        },
        watch: {
          ["tabs,selectedFilePath"]() {
            if (!this.__inited) {
              return;
            }

            // 记录激活中的地址
            const { tabs, selectedFilePath } = this;

            sessionStorage.__actives_path = JSON.stringify({
              tabs: tabs.map((e) => {
                return {
                  ...e,
                  hasChange: undefined,
                };
              }),
              selectedFilePath,
            });
          },
        },
        proto: {
          changeTabStatus({ data }) {
            const targetTab = this.tabs.find((e) => e.path === data.path);
            targetTab.hasChange = data.hasChange;
          },
          changeValue(event) {
            console.log("change: ", event.data.value);

            // 找到激活中的tab，设置的星标
            const targetTab = this.tabs.find(
              (e) => e.path === this.selectedFilePath
            );

            targetTab.notResident = null;
            targetTab.hasChange = true;
          },
          clickTab(data) {
            this.selectedFilePath = data.path;
          },
          dblclickItem(data, event) {
            event.stopPropagation();

            if (!data.list) {
              this.selectedFilePath = data.path;

              const exitedTab = this.tabs.find(
                (e) => e.path === this.selectedFilePath
              );

              // 不在tabs上就直接添加
              if (!exitedTab) {
                this.tabs.push({
                  name: data.name,
                  path: data.path,
                });
              } else {
                exitedTab.notResident = null;
              }
            }
          },
          clickTabClose(index) {
            if (index > -1) {
              const old = this.tabs.splice(index, 1);

              // 清除编辑器的缓存内容
              this.shadow.$("ocode-area").clear(old[0].path);

              if (this.tabs[index]) {
                this.selectedFilePath = this.tabs[index].path;
              } else if (this.tabs.length) {
                this.selectedFilePath = this.tabs.slice(-1)[0].path;
              } else {
                this.selectedFilePath = "";
              }
            }
          },
          clickItem(data, event) {
            event.stopPropagation();

            if (!data.list) {
              this.selectedFilePath = data.path;

              const exitedTab = this.tabs.find(
                (e) => e.path === this.selectedFilePath
              );

              if (!exitedTab) {
                // 查看是否有未常驻的
                const notResTab = this.tabs.find((e) => e.notResident);
                if (notResTab) {
                  notResTab.name = data.name;
                  notResTab.path = data.path;
                } else {
                  this.tabs.push({
                    name: data.name,
                    path: data.path,
                    notResident: 1, // 未常驻的状态
                    hasChange: null,
                  });
                }
              }
            }
          },
          // 初始化项目
          initProject(packageData) {
            this.list = packageData.list;

            let targetItem = null;

            const findItem = (list, path) => {
              return list.find((e) => {
                if (e.list) {
                  return findItem(e.list, path);
                }

                if (e.path === path) {
                  targetItem = e;
                  return true;
                }

                return false;
              });
            };

            findItem(packageData.list, packageData.defaultSelectedPath);

            if (targetItem) {
              this.tabs.push({
                name: targetItem.name,
                path: targetItem.path,
              });

              this.selectedFilePath = packageData.defaultSelectedPath;
            }
          },
          restoreTabs() {
            // 初始化刷新前激活中的tab
            if (sessionStorage.__actives_path) {
              const { tabs, selectedFilePath } = JSON.parse(
                sessionStorage.__actives_path
              );

              this.tabs = tabs;
              this.selectedFilePath = selectedFilePath;
            }

            this.__inited = 1;
          },
        },
        async ready() {
          // 读取目标目录
          const searchParams = new URLSearchParams(location.search);

          const needOpen = searchParams.get("open");

          if (needOpen) {
            // 打开本地目录
            const targetFolder = await get(needOpen);

            const list = await getListData(targetFolder);

            this.initProject({
              defaultSelectedPath: "",
              list: [
                {
                  name: targetFolder.name,
                  path: targetFolder.name,
                  loaded: true,
                  folder: "open",
                  list,
                },
              ],
            });

            this.restoreTabs();
            return;
          }

          this.initProject({
            defaultSelectedPath: "", // 默认选择中的文件路径
            list: [], // 文件夹列表
          });
        },
        attached() {
          // 添加快捷键
          window.addEventListener(
            "keydown",
            (this._key_fun = (event) => {
              if (event.metaKey || event.ctrlKey) {
                if (event.key === "s") {
                  // 保存
                  event.preventDefault();
                  this.shadow.$("ocode-area").save();
                } else if (event.key === "w") {
                  // 关闭标签
                  event.preventDefault();
                  const targetTabIndex = this.tabs.findIndex(
                    (e) => e.path === this.selectedFilePath
                  );

                  if (targetTabIndex > -1) {
                    this.clickTabClose(targetTabIndex);
                  }
                }
              }
            })
          );
        },
        detached() {
          window.removeEventListener("keydown", this._key_fun);
        },
      };
    };
  </script>
</template>
